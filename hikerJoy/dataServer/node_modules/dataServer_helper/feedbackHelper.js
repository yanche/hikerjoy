
var Q = require('q');
var dataBase = require('hikerJoy_dataBase');

//input: array of activity, need .organizer
var getAndReplaceOrganizerNames = function (acts) {
    if(Array.isArray(acts)) {
        var prms = acts.map(function (v) {
            var defer = new Q.defer();
            if(Array.isArray(v.organizer) && v.organizer.length > 0) {
                dataBase.getActiveUsersFieldsBy({'_id': {'$in': v.organizer}}, {'personalInfo.name': 1, 'personalInfo.email': 1})
                .then(function (users) {
                    if(!Array.isArray(users))
                        users = [];
                    v.organizerNames = users.map(function (user) {return user.personalInfo.name + '(' + user.personalInfo.email + ')'; });
                    defer.resolve();
                })
                .fail(function (err) {
                    v.organizerNames = [];
                    defer.reject(err);
                });
            }
            else {
                v.organizerNames = [];
                defer.resolve();
            }
            delete v.organizer;
            return defer.promise;
        });
        return Q.all(prms);
    }
    else
        throw new Error('invalid input for feedbackHelper.getAndReplaceOrganizerNames');
};

exports.getAndReplaceOrganizerNames = getAndReplaceOrganizerNames;
