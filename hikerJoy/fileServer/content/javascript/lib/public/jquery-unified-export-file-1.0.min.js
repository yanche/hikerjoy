/*
 * jQuery JavaScript Unified Export File Library v1.0
 * http://dotnetmagazines.wordpress.com/
 *
 * Copyright 2013, Kevin Ly
 *
 * Date: Sat Aug 24 11:34:00 AM
 */
(function(a){a.UnifiedExportFile=function(l){var j={action:"/",data:{},downloadType:"Normal",ajaxLoadingSelector:".ajax-loading",maximumBar:400,progressBarSelector:".progress",calculatingSelector:".cal-progress",onSuccessCallBack:function(){a.UnifiedExportFile.onSuccessDefaultCallBack()},onFailCallBack:function(){a.UnifiedExportFile.onFailDefaultCallBack()}},f,g;a.UnifiedExportFile.createIframeDownload=function(b){var c=a('<iframe id="frmExportFile" target="_blank" name="frmExportFile" style="display:none" src="'+b+'"></iframe>');c.appendTo("body")};a.UnifiedExportFile.onSuccessDefaultCallBack=function(){var a="Completed exporting file from the server back to the client";console.log(a);alert(a)};a.UnifiedExportFile.onFailDefaultCallBack=function(){var a="There's error occured while exporting file from the server";console.log(a);alert(a)};var b=a.extend(j,l);a.UnifiedExportFile.progressChanged=function(e){var c=a(b.progressBarSelector),d=c.width()+e;if(d<=b.maximumBar){c.width(d);c.html("Loading "+Math.floor(d*100/b.maximumBar)+"%")}else{clearInterval(f);c.width(b.maximumBar);c.html("Completed 100%");a("#frmExportFile").remove();b.onSuccessCallBack()}};a.UnifiedExportFile.getCookie=function(d){var a=document.cookie,b=a.indexOf(" "+d+"=");if(b==-1)b=a.indexOf(d+"=");if(b==-1)a=null;else{b=a.indexOf("=",b)+1;var c=a.indexOf(";",b);if(c==-1)c=a.length;a=unescape(a.substring(b,c))}return a};a.UnifiedExportFile.removeCookie=function(f){for(var c=document.cookie.split(";"),b=0;b<c.length;b++){var a=c[b],d=a.indexOf("="),e=d>-1?a.substr(0,d):a;if(e==f)document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/"}};a.UnifiedExportFile.checkDownloadFileCompletely=function(){var c=a.UnifiedExportFile.getCookie("Downloaded");if(c=="True"){a(b.ajaxLoadingSelector).hide();a.UnifiedExportFile.removeCookie("Downloaded");clearInterval(g);a("#frmExportFile").remove();b.onSuccessCallBack()}};var i=false;if(b.action.length<=0){console.log("Action URL must be a valid URL and not empty");i=true}b.ajaxLoadingSelector.length<=0&&console.log("Ajax Loading Selector doesn't exist");if(!i){var d="?",e="",c=b.action;a("#frmExportFile").remove();a.UnifiedExportFile.removeCookie("Downloaded");for(var h in b.data){e=h+"="+b.data[h];d=d+(d.length>1?"&"+e:e)}if(d.length>1)c=c+d;switch(b.downloadType){case"Normal":a.UnifiedExportFile.createIframeDownload(c);break;case"Progress":a(b.ajaxLoadingSelector).show();a.UnifiedExportFile.createIframeDownload(c);g=setInterval("$.UnifiedExportFile.checkDownloadFileCompletely()",1e3);break;case"ProgressBar":a(b.ajaxLoadingSelector).show();a(b.calculatingSelector).length<=0&&a('<div class="cal-progress">Calculating and checking...</div>').insertAfter(a(b.ajaxLoadingSelector));var k=(new Date).getTime();a.ajax({url:c,success:function(){a(b.progressBarSelector).length<=0&&a('<div style="width: '+b.maximumBar+'px; border: 2px solid #bc3d11; height: 20px;"><div class="progress" style="color: white; background-color:#2383c4; width: 0px">Loading</div></div>').insertAfter(a(b.ajaxLoadingSelector));var e=(new Date).getTime()-k;a(".cal-progress, "+b.ajaxLoadingSelector).hide();var d=b.maximumBar/(e/1e3);a.UnifiedExportFile.createIframeDownload(c);f=setInterval("$.UnifiedExportFile.progressChanged("+d+")",1e3)},error:b.onFailCallBack,complete:function(){a(".cal-progress, "+b.ajaxLoadingSelector).hide()}});break;default:a.UnifiedExportFile.createIframeDownload(c)}}return false}})(jQuery)